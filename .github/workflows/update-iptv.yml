name: Update ahuniptv.m3u

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 */6 * * *"  # æ¯6å°æ—¶è‡ªåŠ¨æ›´æ–°

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§© Checkout repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Install curl & tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl dos2unix

      - name: ğŸ“¥ Download ahuniptv.m3u
        run: |
          mkdir -p tmp
          cd tmp
          echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½ ahuniptv.m3u ..."
          # ä½¿ç”¨ --http1.1 é˜²æ­¢ HTTP/2 åè®®é”™è¯¯
          if ! curl -L --http1.1 --retry 5 --retry-delay 5 -o ahuniptv.m3u https://www.wmviv.com/iptv/ahuniptv.m3u; then
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œé€€å‡º"
            exit 0
          fi

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s ahuniptv.m3u ]; then
            echo "âš ï¸ ä¸‹è½½å¤±è´¥æˆ–å†…å®¹ä¸ºç©ºï¼Œè·³è¿‡æ›´æ–°ã€‚"
            exit 0
          fi

      - name: ğŸ§¾ Modify header
        run: |
          cd tmp
          echo "ğŸ§¾ æ­£åœ¨ä¿®æ”¹æ–‡ä»¶å¤´..."
          # ç›®æ ‡å¤´éƒ¨
          NEW_HEADER='#EXTM3U url-tvg="http://epg.51zmt.top:8000/e.xml" catchup="append" catchup-source="?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}"'
          
          # åˆ é™¤æ—§å¤´éƒ¨å¹¶æ·»åŠ æ–°çš„
          tail -n +2 ahuniptv.m3u > body.m3u
          echo "$NEW_HEADER" > ahuniptv.m3u
          cat body.m3u >> ahuniptv.m3u
          rm body.m3u
          
          dos2unix ahuniptv.m3u
          mv ahuniptv.m3u ../ahuniptv.m3u

      - name: ğŸª£ Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "âœ… æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git add ahuniptv.m3u
            git commit -m "ğŸ”„ Update ahuniptv.m3u ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push
          fi
